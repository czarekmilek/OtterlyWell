import{a as z,r as m,s as f,j as t,m as v,k as T,g as C,l as D,q}from"./index-D0n_Bh0Q.js";import{A as E,C as M}from"./ConfirmDeleteDialog-I1_PaFl6.js";function P(){const{user:i}=z(),[d,o]=m.useState([]),[p,u]=m.useState([]),[x,h]=m.useState(!0),b=m.useCallback(async()=>{if(i)try{const{data:a,error:r}=await f.from("task_categories").select("*").order("order_index",{ascending:!0}).order("created_at",{ascending:!0});if(r)throw r;u(a||[])}catch(a){console.error("Error fetching categories:",a)}},[i]),c=m.useCallback(async()=>{if(i)try{const{data:a,error:r}=await f.from("tasks").select("*").order("priority",{ascending:!1}).order("created_at",{ascending:!1});if(r)throw r;o(a||[])}catch(a){console.error("Error fetching tasks:",a)}},[i]);return m.useEffect(()=>{i&&(async()=>{h(!0),await Promise.all([b(),c()]),h(!1)})()},[i,b,c]),{tasks:d,setTasks:o,categories:p,setCategories:u,isLoading:x,user:i}}function $({user:i,tasks:d,setTasks:o}){const p=m.useCallback(async a=>{if(!i)return;const r={...a,user_id:i.id,is_completed:!1};try{const{data:e,error:n}=await f.from("tasks").insert(r).select().single();if(n)throw n;o(s=>[...s,e])}catch(e){console.error("Error adding task:",e)}},[i,o]),u=m.useCallback(async a=>{const r=d.find(s=>s.id===a);if(!r)return;const e=!r.is_completed,n=e?new Date().toISOString():null;o(s=>s.map(l=>l.id===a?{...l,is_completed:e,completed_at:n||void 0}:l));try{const{error:s}=await f.from("tasks").update({is_completed:e,completed_at:n}).eq("id",a);if(s)throw o(l=>l.map(y=>y.id===a?r:y)),s}catch(s){console.error("Error toggling task completion:",s)}},[d,o]),x=m.useCallback(async a=>{const r=[...d];o(e=>e.filter(n=>n.id!==a));try{const{error:e}=await f.from("tasks").delete().eq("id",a);if(e)throw o(r),e}catch(e){console.error("Error deleting task:",e)}},[d,o]),h=m.useCallback(async a=>{if(d.find(e=>e.id===a)){o(e=>e.map(n=>n.id===a?{...n,is_dismissed:!0}:n));try{const{error:e}=await f.from("tasks").update({is_dismissed:!0}).eq("id",a);if(e)throw o(n=>n.map(s=>s.id===a?{...s,is_dismissed:!1}:s)),e}catch(e){console.error("Error dismissing task:",e)}}},[d,o]),b=m.useCallback(async a=>{if(d.find(e=>e.id===a)){o(e=>e.map(n=>n.id===a?{...n,is_dismissed:!1}:n));try{const{error:e}=await f.from("tasks").update({is_dismissed:!1}).eq("id",a);if(e)throw o(n=>n.map(s=>s.id===a?{...s,is_dismissed:!0}:s)),e}catch(e){console.error("Error restoring task:",e)}}},[d,o]),c=m.useCallback(async(a,r)=>{const e=d.find(s=>s.id===a);if(!e)return;const n={...e,...r};o(s=>s.map(l=>l.id===a?n:l));try{const{error:s}=await f.from("tasks").update(r).eq("id",a);if(s)throw o(l=>l.map(y=>y.id===a?e:y)),s}catch(s){console.error("Error editing task:",s)}},[d,o]);return{addTask:p,toggleTaskCompletion:u,deleteTask:x,dismissTask:h,restoreTask:b,editTask:c}}function A({user:i,categories:d,setCategories:o}){const p=m.useCallback(async c=>{const a=d.find(e=>e.id===c);if(!a)return;const r=!a.is_active;o(e=>e.map(n=>n.id===c?{...n,is_active:r}:n));try{const{error:e}=await f.from("task_categories").update({is_active:r}).eq("id",c);if(e)throw o(n=>n.map(s=>s.id===c?a:s)),e}catch(e){console.error("Error toggling category:",e)}},[d,o]),u=m.useCallback(async c=>{if(!i)return;const a={name:c,is_active:!0,user_id:i.id};try{const{data:r,error:e}=await f.from("task_categories").insert(a).select().single();if(e)throw e;o(n=>[...n,r])}catch(r){console.error("Error adding category:",r)}},[i,o]),x=m.useCallback(async c=>{const a=d.find(r=>r.id===c);if(a){o(r=>r.filter(e=>e.id!==c));try{const{error:r}=await f.from("tasks").delete().eq("category_id",c);if(r){console.error("Error deleting category tasks:",r),o(n=>[...n,a]);return}const{error:e}=await f.from("task_categories").delete().eq("id",c);if(e)throw o(n=>[...n,a]),e}catch(r){console.error("Error deleting category:",r)}}},[d,o]),h=m.useCallback(async c=>{o(a=>a.map(r=>{const e=c.findIndex(n=>n.id===r.id);return e!==-1?{...r,order_index:e}:r}).sort((r,e)=>(r.order_index??0)-(e.order_index??0)));try{const a=c.map((e,n)=>({id:e.id,order_index:n,user_id:i?.id,name:e.name,is_active:e.is_active})),{error:r}=await f.from("task_categories").upsert(a,{onConflict:"id"});if(r)throw r}catch(a){console.error("Error reordering categories:",a)}},[o,i]),b=m.useCallback(async(c,a)=>{const r=d.find(e=>e.id===c);if(r&&r.name!==a){o(e=>e.map(n=>n.id===c?{...n,name:a}:n));try{const{error:e}=await f.from("task_categories").update({name:a}).eq("id",c);if(e)throw o(n=>n.map(s=>s.id===c?r:s)),e}catch(e){console.error("Error updating category:",e)}}},[d,o]);return{toggleCategory:p,addCategory:u,deleteCategory:x,reorderCategories:h,editCategory:b}}function U(){const{tasks:i,setTasks:d,categories:o,setCategories:p,isLoading:u,user:x}=P(),{addTask:h,toggleTaskCompletion:b,deleteTask:c,dismissTask:a,restoreTask:r,editTask:e}=$({user:x,tasks:i,setTasks:d}),{toggleCategory:n,addCategory:s,deleteCategory:l,reorderCategories:y,editCategory:_}=A({user:x,categories:o,setCategories:p});return{tasks:i,categories:o,isLoading:u,addTask:h,toggleTaskCompletion:b,deleteTask:c,toggleCategory:n,addCategory:s,deleteCategory:async g=>{d(w=>w.filter(N=>N.category_id!==g)),await l(g)},dismissTask:a,restoreTask:r,editTask:e,reorderCategories:y,editCategory:_}}function L({isOpen:i,onClose:d,onSubmit:o,categories:p,initialData:u}){const[x,h]=m.useState(u?.description||""),[b,c]=m.useState(u?.category_id||p[0]?.id||""),[a,r]=m.useState(u?.priority||1),[e,n]=m.useState(u?.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");m.useEffect(()=>{if(i){if(u)h(u.description),c(u.category_id),r(u.priority),n(u.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");else if(p.length>0&&!x&&!u){const l=p.some(y=>y.id===b);(!b||!l)&&c(p[0].id)}}i&&!u&&!x&&(r(1),n(""))},[i,p,b,u]);const s=l=>{l.preventDefault(),!(!x.trim()||!b)&&(o({description:x,category_id:b,priority:a,deadline:e?new Date(e).toISOString():void 0}),u||(h(""),r(1),n("")),d())};return t.jsx(E,{children:i&&t.jsxs(t.Fragment,{children:[t.jsx(v.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d,className:"fixed inset-0 bg-brand-neutral-darker/70 backdrop-blur-sm z-50"}),t.jsx(v.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:t.jsxs("div",{className:"w-full max-w-lg bg-brand-neutral-darker border border-brand-depth rounded-2xl shadow-2xl pointer-events-auto mx-4 overflow-hidden",children:[t.jsxs("div",{className:"p-6 border-b border-brand-depth flex justify-between items-center bg-brand-neutral-dark/50",children:[t.jsx("h2",{className:"text-xl font-bold text-brand-neutral-light",children:u?"Edytuj zadanie":"Dodaj nowe zadanie"}),t.jsx("button",{onClick:d,className:"text-brand-neutral-light/60 hover:text-brand-neutral-light transition-colors",children:t.jsx(T,{})})]}),t.jsxs("form",{onSubmit:s,className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Treść zadania"}),t.jsx("textarea",{value:x,onChange:l=>h(l.target.value),className:`w-full px-4 py-3 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light placeholder-brand-neutral-light/30 focus:outline-none focus:border-brand-primary`,placeholder:"Co musisz zrobić?",rows:3,required:!0})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Kategoria"}),t.jsx("select",{value:b,onChange:l=>c(l.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                             text-brand-neutral-light focus:outline-none focus:border-brand-primary`,children:p.map(l=>t.jsx("option",{value:l.id,children:l.name},l.id))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Priorytet"}),t.jsx("div",{className:"flex gap-2",children:[1,2,3].map(l=>t.jsx("button",{type:"button",onClick:()=>r(l),className:`flex-1 py-2.5 rounded-xl border transition-all font-bold text-sm
                                                ${a===l?l===3?"bg-brand-negative text-white border-brand-negative":l===2?"bg-brand-accent-3 text-white border-brand-accent-3":"bg-brand-accent-2 text-white border-brand-accent-2":"border-brand-depth text-brand-neutral-light/60 hover:border-brand-neutral-light/40"}`,children:l===3?"!!!":l===2?"!!":"!"},l))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Termin (opcjonalnie)"}),t.jsx("input",{type:"date",value:e,onChange:l=>n(l.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light focus:outline-none focus:border-brand-primary [color-scheme:dark]`})]}),t.jsx("div",{className:"pt-4",children:t.jsx("button",{type:"submit",className:`w-full py-3 bg-brand-primary rounded-xl text-brand-neutral-light font-bold \r
                                         hover:bg-brand-primary/90 transition-all shadow-lg active:scale-97 cursor-pointer`,children:u?"Zapisz zmiany":"Dodaj zadanie"})})]})]})})]})})}function O({task:i,categories:d,onComplete:o,onDismiss:p,onEdit:u,currentDate:x}){const h={1:"border-brand-accent-2/50 bg-brand-accent-2/10",2:"border-brand-accent-1/50 bg-brand-accent-1/10",3:"border-brand-negative/50 bg-brand-negative/10"},b={1:"Niski",2:"Normalny",3:"Wysoki"},a=(g=>{if(!g)return null;const w=new Date(g),N=new Date(x);w.setHours(0,0,0,0),N.setHours(0,0,0,0);const S=w.getTime()-N.getTime(),j=Math.ceil(S/(1e3*60*60*24));return j<0?{text:`Dni opóźnienia: ${Math.abs(j)}`,className:"text-brand-negative font-bold"}:j===0?{text:"Dzisiaj",className:"text-brand-accent-3 font-bold"}:j===1?{text:"Jutro",className:"text-brand-neutral-light/80"}:{text:`Pozostałe dni: ${j}`,className:"text-brand-neutral-light/60"}})(i.deadline),r=i.is_completed,e=r?"bg-brand-neutral-dark/40 border-brand-neutral-light/20 opacity-70":h[i.priority],[n,s]=m.useState(!1),[l,y]=m.useState(!1),[_,k]=m.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs(v.div,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},onClick:()=>s(!n),className:`relative p-3 rounded-xl border ${e} 
                    group hover:shadow-md transition-all cursor-pointer select-none`,children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("button",{onClick:g=>{g.stopPropagation(),o(i.id)},className:`mt-1 w-5 h-5 rounded-full border-2 transition-all flex-shrink-0 flex items-center justify-center cursor-pointer
                       ${r?"bg-brand-positive border-brand-positive hover:bg-brand-secondary hover:border-brand-secondary text-brand-neutral-darker":"border-brand-neutral-light/50 hover:border-brand-accent-1 hover:bg-brand-accent-1/20"}`,children:r&&t.jsx(C,{className:"scale-75"})}),t.jsxs("div",{className:"flex-grow min-w-0",children:[t.jsx("p",{className:`text-brand-neutral-light text-sm font-medium leading-tight break-words transition-all
                        ${r?"line-through text-brand-neutral-light/50 truncate pr-17":"truncate pr-17"}`,children:i.description}),n&&t.jsx(v.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-2 text-xs text-brand-neutral-light/70 whitespace-pre-wrap border-l-2 border-brand-neutral-light/20 pl-2",children:t.jsx("span",{className:"block mt-1 pt-1 border-t border-brand-neutral-light/10",children:i.description})}),t.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[!r&&t.jsxs("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded
                               ${i.priority===3?"text-brand-negative-darker/60 bg-brand-negative/30":i.priority===2?"text-brand-accent-1/90 bg-brand-accent-3/30":"text-brand-neutral-light/80 bg-brand-accent-2/30"}`,children:[b[i.priority]," priorytet"]}),a&&!r&&t.jsx("span",{className:`text-[10px] ${a.className}`,children:a.text}),r&&i.completed_at&&t.jsxs("span",{className:"text-[10px] text-brand-neutral-light/40",children:["Ukończono: ",new Date(i.completed_at).toLocaleDateString()]})]})]})]}),!r&&n&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100",children:t.jsx("button",{onClick:g=>{g.stopPropagation(),k(!0)},className:`p-1 hover:bg-brand-neutral-light/20 rounded-full text-brand-neutral-light/60 hover:text-brand-neutral-light \r
                     text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Edytuj",children:t.jsx(D,{className:"scale-75"})})}),r&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx("button",{onClick:g=>{g.stopPropagation(),y(!0)},className:`p-1 hover:bg-brand-negative/20 rounded-full text-brand-neutral-light/60 hover:text-brand-negative-darker \r
                    text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Usuń",children:t.jsx(q,{className:"scale-85"})})})]}),t.jsx(M,{isOpen:l,onClose:()=>y(!1),onConfirm:()=>p(i.id),title:"Przenieś do historii",confirmLabel:"Przenieś",description:t.jsxs("p",{children:["Czy na pewno chcesz przenieść to zadanie"," ",i.description?t.jsxs(t.Fragment,{children:["(",t.jsx("strong",{className:"text-brand-neutral-light truncate inline-block max-w-[200px] align-bottom",children:i.description}),")"]}):""," ","do historii?"]})}),t.jsx(L,{isOpen:_,onClose:()=>k(!1),onSubmit:g=>u(i.id,g),categories:d,initialData:i})]})}function B({category:i,tasks:d,allCategories:o,onComplete:p,onDismiss:u,onEdit:x,currentDate:h}){const b=m.useMemo(()=>[...d].sort((r,e)=>r.is_completed!==e.is_completed?r.is_completed?1:-1:e.priority!==r.priority?e.priority-r.priority:new Date(e.created_at).getTime()-new Date(r.created_at).getTime()),[d]),c=d.filter(r=>r.is_completed),a=d.length>0&&c.length===d.length;return t.jsxs("div",{className:"flex flex-col h-full bg-brand-neutral-dark/30 border border-brand-depth rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:`p-4 border-b border-brand-depth flex items-center justify-between
                      ${a?"bg-brand-positive/10":"bg-brand-neutral-dark/40"}`,children:[t.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:a&&t.jsx(v.div,{initial:{scale:0},animate:{scale:1},className:"w-6 h-6 bg-brand-positive rounded-full flex items-center justify-center text-brand-neutral-darker",children:t.jsx(C,{className:"scale-90"})})}),t.jsx("h3",{className:"font-bold text-lg text-brand-neutral-light truncate",children:i.name}),t.jsx("span",{className:"text-xs text-brand-neutral-light/40 bg-brand-neutral-dark/50 px-2 py-1 rounded-lg",children:d.length})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3 min-h-[200px]",children:[t.jsx(E,{mode:"popLayout",children:b.map(r=>t.jsx(O,{task:r,categories:o,onComplete:p,onDismiss:u,onEdit:x,currentDate:h},r.id))}),d.length===0&&t.jsx("div",{className:"h-full flex flex-col items-center justify-center text-brand-neutral-light/30 p-4 text-center",children:t.jsx("p",{className:"text-sm",children:"Brak zadań"})})]})]})}export{L as A,B as T,U as u};
