import{a as z,r as p,s as f,j as e,i as T,f as _,k as D,D as M}from"./index-B2Fph0LG.js";import{A as E,C as P}from"./ConfirmDeleteDialog-HNYu6QpB.js";import{m as v}from"./proxy-j0g64NeB.js";function q(){const{user:n}=z(),[s,i]=p.useState([]),[x,c]=p.useState([]),[h,m]=p.useState(!0),b=p.useCallback(async()=>{if(n)try{const{data:r,error:t}=await f.from("task_categories").select("*").order("created_at",{ascending:!0});if(t)throw t;c(r||[])}catch(r){console.error("Error fetching categories:",r)}},[n]),u=p.useCallback(async()=>{if(n)try{const{data:r,error:t}=await f.from("tasks").select("*").order("priority",{ascending:!1}).order("created_at",{ascending:!1});if(t)throw t;i(r||[])}catch(r){console.error("Error fetching tasks:",r)}},[n]);return p.useEffect(()=>{n&&(async()=>{m(!0),await Promise.all([b(),u()]),m(!1)})()},[n,b,u]),{tasks:s,setTasks:i,categories:x,setCategories:c,isLoading:h,user:n}}function $({user:n,tasks:s,setTasks:i}){const x=p.useCallback(async r=>{if(!n)return;const t={...r,user_id:n.id,is_completed:!1};try{const{data:a,error:d}=await f.from("tasks").insert(t).select().single();if(d)throw d;i(l=>[...l,a])}catch(a){console.error("Error adding task:",a)}},[n,i]),c=p.useCallback(async r=>{const t=s.find(l=>l.id===r);if(!t)return;const a=!t.is_completed,d=a?new Date().toISOString():null;i(l=>l.map(o=>o.id===r?{...o,is_completed:a,completed_at:d||void 0}:o));try{const{error:l}=await f.from("tasks").update({is_completed:a,completed_at:d}).eq("id",r);if(l)throw i(o=>o.map(y=>y.id===r?t:y)),l}catch(l){console.error("Error toggling task completion:",l)}},[s,i]),h=p.useCallback(async r=>{const t=[...s];i(a=>a.filter(d=>d.id!==r));try{const{error:a}=await f.from("tasks").delete().eq("id",r);if(a)throw i(t),a}catch(a){console.error("Error deleting task:",a)}},[s,i]),m=p.useCallback(async r=>{if(s.find(a=>a.id===r)){i(a=>a.map(d=>d.id===r?{...d,is_dismissed:!0}:d));try{const{error:a}=await f.from("tasks").update({is_dismissed:!0}).eq("id",r);if(a)throw i(d=>d.map(l=>l.id===r?{...l,is_dismissed:!1}:l)),a}catch(a){console.error("Error dismissing task:",a)}}},[s,i]),b=p.useCallback(async r=>{if(s.find(a=>a.id===r)){i(a=>a.map(d=>d.id===r?{...d,is_dismissed:!1}:d));try{const{error:a}=await f.from("tasks").update({is_dismissed:!1}).eq("id",r);if(a)throw i(d=>d.map(l=>l.id===r?{...l,is_dismissed:!0}:l)),a}catch(a){console.error("Error restoring task:",a)}}},[s,i]),u=p.useCallback(async(r,t)=>{const a=s.find(l=>l.id===r);if(!a)return;const d={...a,...t};i(l=>l.map(o=>o.id===r?d:o));try{const{error:l}=await f.from("tasks").update(t).eq("id",r);if(l)throw i(o=>o.map(y=>y.id===r?a:y)),l}catch(l){console.error("Error editing task:",l)}},[s,i]);return{addTask:x,toggleTaskCompletion:c,deleteTask:h,dismissTask:m,restoreTask:b,editTask:u}}function A({user:n,categories:s,setCategories:i}){const x=p.useCallback(async m=>{const b=s.find(r=>r.id===m);if(!b)return;const u=!b.is_active;i(r=>r.map(t=>t.id===m?{...t,is_active:u}:t));try{const{error:r}=await f.from("task_categories").update({is_active:u}).eq("id",m);if(r)throw i(t=>t.map(a=>a.id===m?b:a)),r}catch(r){console.error("Error toggling category:",r)}},[s,i]),c=p.useCallback(async m=>{if(!n)return;const b={name:m,is_active:!0,user_id:n.id};try{const{data:u,error:r}=await f.from("task_categories").insert(b).select().single();if(r)throw r;i(t=>[...t,u])}catch(u){console.error("Error adding category:",u)}},[n,i]),h=p.useCallback(async m=>{const b=s.find(u=>u.id===m);if(b){i(u=>u.filter(r=>r.id!==m));try{const{error:u}=await f.from("tasks").delete().eq("category_id",m);if(u){console.error("Error deleting category tasks:",u),i(t=>[...t,b]);return}const{error:r}=await f.from("task_categories").delete().eq("id",m);if(r)throw i(t=>[...t,b]),r}catch(u){console.error("Error deleting category:",u)}}},[s,i]);return{toggleCategory:x,addCategory:c,deleteCategory:h}}function B(){const{tasks:n,setTasks:s,categories:i,setCategories:x,isLoading:c,user:h}=q(),{addTask:m,toggleTaskCompletion:b,deleteTask:u,dismissTask:r,restoreTask:t,editTask:a}=$({user:h,tasks:n,setTasks:s}),{toggleCategory:d,addCategory:l,deleteCategory:o}=A({user:h,categories:i,setCategories:x});return{tasks:n,categories:i,isLoading:c,addTask:m,toggleTaskCompletion:b,deleteTask:u,toggleCategory:d,addCategory:l,deleteCategory:async w=>{s(N=>N.filter(g=>g.category_id!==w)),await o(w)},dismissTask:r,restoreTask:t,editTask:a}}function L({isOpen:n,onClose:s,onSubmit:i,categories:x,initialData:c}){const[h,m]=p.useState(c?.description||""),[b,u]=p.useState(c?.category_id||x[0]?.id||""),[r,t]=p.useState(c?.priority||1),[a,d]=p.useState(c?.deadline?new Date(c.deadline).toISOString().split("T")[0]:"");p.useEffect(()=>{if(n){if(c)m(c.description),u(c.category_id),t(c.priority),d(c.deadline?new Date(c.deadline).toISOString().split("T")[0]:"");else if(x.length>0&&!h&&!c){const o=x.some(y=>y.id===b);(!b||!o)&&u(x[0].id)}}n&&!c&&!h&&(t(1),d(""))},[n,x,b,c]);const l=o=>{o.preventDefault(),!(!h.trim()||!b)&&(i({description:h,category_id:b,priority:r,deadline:a?new Date(a).toISOString():void 0}),c||(m(""),t(1),d("")),s())};return e.jsx(E,{children:n&&e.jsxs(e.Fragment,{children:[e.jsx(v.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:s,className:"fixed inset-0 bg-brand-neutral-darker/70 backdrop-blur-sm z-50"}),e.jsx(v.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsxs("div",{className:"w-full max-w-lg bg-brand-neutral-darker border border-brand-depth rounded-2xl shadow-2xl pointer-events-auto mx-4 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-brand-depth flex justify-between items-center bg-brand-neutral-dark/50",children:[e.jsx("h2",{className:"text-xl font-bold text-brand-neutral-light",children:c?"Edytuj zadanie":"Dodaj nowe zadanie"}),e.jsx("button",{onClick:s,className:"text-brand-neutral-light/60 hover:text-brand-neutral-light transition-colors",children:e.jsx(T,{})})]}),e.jsxs("form",{onSubmit:l,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Treść zadania"}),e.jsx("textarea",{value:h,onChange:o=>m(o.target.value),className:`w-full px-4 py-3 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light placeholder-brand-neutral-light/30 focus:outline-none focus:border-brand-primary`,placeholder:"Co musisz zrobić?",rows:3,required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Kategoria"}),e.jsx("select",{value:b,onChange:o=>u(o.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                             text-brand-neutral-light focus:outline-none focus:border-brand-primary`,children:x.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Priorytet"}),e.jsx("div",{className:"flex gap-2",children:[1,2,3].map(o=>e.jsx("button",{type:"button",onClick:()=>t(o),className:`flex-1 py-2.5 rounded-xl border transition-all font-bold text-sm
                                                ${r===o?o===3?"bg-brand-negative text-white border-brand-negative":o===2?"bg-brand-accent-3 text-white border-brand-accent-3":"bg-brand-accent-2 text-white border-brand-accent-2":"border-brand-depth text-brand-neutral-light/60 hover:border-brand-neutral-light/40"}`,children:o===3?"!!!":o===2?"!!":"!"},o))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Termin (opcjonalnie)"}),e.jsx("input",{type:"date",value:a,onChange:o=>d(o.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light focus:outline-none focus:border-brand-primary [color-scheme:dark]`})]}),e.jsx("div",{className:"pt-4",children:e.jsx("button",{type:"submit",className:`w-full py-3 bg-brand-primary rounded-xl text-brand-neutral-light font-bold \r
                                         hover:bg-brand-primary/90 transition-all shadow-lg active:scale-97 cursor-pointer`,children:c?"Zapisz zmiany":"Dodaj zadanie"})})]})]})})]})})}function O({task:n,categories:s,onComplete:i,onDismiss:x,onEdit:c,currentDate:h}){const m={1:"border-brand-accent-2/50 bg-brand-accent-2/10",2:"border-brand-accent-1/50 bg-brand-accent-1/10",3:"border-brand-negative/50 bg-brand-negative/10"},b={1:"Niski",2:"Normalny",3:"Wysoki"},r=(g=>{if(!g)return null;const C=new Date(g),k=new Date(h);C.setHours(0,0,0,0),k.setHours(0,0,0,0);const S=C.getTime()-k.getTime(),j=Math.ceil(S/(1e3*60*60*24));return j<0?{text:`Dni opóźnienia: ${Math.abs(j)}`,className:"text-brand-negative font-bold"}:j===0?{text:"Dzisiaj",className:"text-brand-accent-3 font-bold"}:j===1?{text:"Jutro",className:"text-brand-neutral-light/80"}:{text:`Pozostałe dni: ${j}`,className:"text-brand-neutral-light/60"}})(n.deadline),t=n.is_completed,a=t?"bg-brand-neutral-dark/40 border-brand-neutral-light/20 opacity-70":m[n.priority],[d,l]=p.useState(!1),[o,y]=p.useState(!1),[w,N]=p.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(v.div,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},onClick:()=>l(!d),className:`relative p-3 rounded-xl border ${a} 
                    group hover:shadow-md transition-all cursor-pointer select-none`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("button",{onClick:g=>{g.stopPropagation(),i(n.id)},className:`mt-1 w-5 h-5 rounded-full border-2 transition-all flex-shrink-0 flex items-center justify-center cursor-pointer
                       ${t?"bg-brand-positive border-brand-positive text-brand-neutral-darker":"border-brand-neutral-light/50 hover:border-brand-accent-1 hover:bg-brand-accent-1/20"}`,children:t&&e.jsx(_,{className:"scale-75"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsx("p",{className:`text-brand-neutral-light text-sm font-medium leading-tight break-words transition-all
                        ${t?"line-through text-brand-neutral-light/50 truncate pr-17":"truncate"}`,children:n.description}),d&&e.jsx(v.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-2 text-xs text-brand-neutral-light/70 whitespace-pre-wrap border-l-2 border-brand-neutral-light/20 pl-2",children:e.jsx("span",{className:"block mt-1 pt-1 border-t border-brand-neutral-light/10",children:n.description})}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[!t&&e.jsxs("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded
                               ${n.priority===3?"text-brand-negative-darker/60 bg-brand-negative/30":n.priority===2?"text-brand-accent-1/90 bg-brand-accent-3/30":"text-brand-neutral-light/80 bg-brand-accent-2/30"}`,children:[b[n.priority]," priorytet"]}),r&&!t&&e.jsx("span",{className:`text-[10px] ${r.className}`,children:r.text}),t&&n.completed_at&&e.jsxs("span",{className:"text-[10px] text-brand-neutral-light/40",children:["Ukończono: ",new Date(n.completed_at).toLocaleDateString()]})]})]})]}),!t&&d&&e.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100",children:e.jsx("button",{onClick:g=>{g.stopPropagation(),N(!0)},className:`p-1 hover:bg-brand-neutral-light/20 rounded-full text-brand-neutral-light/60 hover:text-brand-neutral-light \r
                     text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Edytuj",children:e.jsx(D,{className:"scale-75"})})}),t&&e.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:g=>{g.stopPropagation(),y(!0)},className:`p-1 hover:bg-brand-negative/20 rounded-full text-brand-neutral-light/60 hover:text-brand-negative-darker \r
                    text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Usuń",children:e.jsx(M,{className:"scale-85"})})})]}),e.jsx(P,{isOpen:o,onClose:()=>y(!1),onConfirm:()=>x(n.id),title:"Przenieś do historii",confirmLabel:"Przenieś",description:e.jsxs("p",{children:["Czy na pewno chcesz przenieść to zadanie"," ",n.description?e.jsxs(e.Fragment,{children:["(",e.jsx("strong",{className:"text-brand-neutral-light truncate inline-block max-w-[200px] align-bottom",children:n.description}),")"]}):""," ","do historii?"]})}),e.jsx(L,{isOpen:w,onClose:()=>N(!1),onSubmit:g=>c(n.id,g),categories:s,initialData:n})]})}function J({category:n,tasks:s,allCategories:i,onComplete:x,onDismiss:c,onEdit:h,currentDate:m}){const b=p.useMemo(()=>[...s].sort((t,a)=>t.is_completed!==a.is_completed?t.is_completed?1:-1:a.priority!==t.priority?a.priority-t.priority:new Date(a.created_at).getTime()-new Date(t.created_at).getTime()),[s]),u=s.filter(t=>t.is_completed),r=s.length>0&&u.length===s.length;return e.jsxs("div",{className:"flex flex-col h-full bg-brand-neutral-dark/30 border border-brand-depth rounded-2xl overflow-hidden",children:[e.jsxs("div",{className:`p-4 border-b border-brand-depth flex items-center justify-between
                      ${r?"bg-brand-positive/10":"bg-brand-neutral-dark/40"}`,children:[e.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:r&&e.jsx(v.div,{initial:{scale:0},animate:{scale:1},className:"w-6 h-6 bg-brand-positive rounded-full flex items-center justify-center text-brand-neutral-darker",children:e.jsx(_,{className:"scale-90"})})}),e.jsx("h3",{className:"font-bold text-lg text-brand-neutral-light truncate",children:n.name}),e.jsx("span",{className:"text-xs text-brand-neutral-light/40 bg-brand-neutral-dark/50 px-2 py-1 rounded-lg",children:s.length})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3 min-h-[200px]",children:[e.jsx(E,{mode:"popLayout",children:b.map(t=>e.jsx(O,{task:t,categories:i,onComplete:x,onDismiss:c,onEdit:h,currentDate:m},t.id))}),s.length===0&&e.jsx("div",{className:"h-full flex flex-col items-center justify-center text-brand-neutral-light/30 p-4 text-center",children:e.jsx("p",{className:"text-sm",children:"Brak zadań"})})]})]})}export{L as A,J as T,B as u};
