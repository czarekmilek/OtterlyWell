import{a as z,r as b,s as g,j as t,m as w,k as T,g as k,l as D,q as M}from"./index-CbrNP7Z6.js";import{A as E,C as q}from"./ConfirmDeleteDialog-QRNexnPa.js";function P(){const{user:n}=z(),[d,i]=b.useState([]),[p,u]=b.useState([]),[x,h]=b.useState(!0),c=b.useCallback(async()=>{if(n)try{const{data:r,error:e}=await g.from("task_categories").select("*").order("order_index",{ascending:!0}).order("created_at",{ascending:!0});if(e)throw e;u(r||[])}catch(r){console.error("Error fetching categories:",r)}},[n]),m=b.useCallback(async()=>{if(n)try{const{data:r,error:e}=await g.from("tasks").select("*").order("priority",{ascending:!1}).order("created_at",{ascending:!1});if(e)throw e;i(r||[])}catch(r){console.error("Error fetching tasks:",r)}},[n]);return b.useEffect(()=>{n&&(async()=>{h(!0),await Promise.all([c(),m()]),h(!1)})()},[n,c,m]),{tasks:d,setTasks:i,categories:p,setCategories:u,isLoading:x,user:n}}function $({user:n,tasks:d,setTasks:i}){const p=b.useCallback(async r=>{if(!n)return;const e={...r,user_id:n.id,is_completed:!1};try{const{data:a,error:s}=await g.from("tasks").insert(e).select().single();if(s)throw s;i(l=>[...l,a])}catch(a){console.error("Error adding task:",a)}},[n,i]),u=b.useCallback(async r=>{const e=d.find(l=>l.id===r);if(!e)return;const a=!e.is_completed,s=a?new Date().toISOString():null;i(l=>l.map(o=>o.id===r?{...o,is_completed:a,completed_at:s||void 0}:o));try{const{error:l}=await g.from("tasks").update({is_completed:a,completed_at:s}).eq("id",r);if(l)throw i(o=>o.map(f=>f.id===r?e:f)),l}catch(l){console.error("Error toggling task completion:",l)}},[d,i]),x=b.useCallback(async r=>{const e=[...d];i(a=>a.filter(s=>s.id!==r));try{const{error:a}=await g.from("tasks").delete().eq("id",r);if(a)throw i(e),a}catch(a){console.error("Error deleting task:",a)}},[d,i]),h=b.useCallback(async r=>{if(d.find(a=>a.id===r)){i(a=>a.map(s=>s.id===r?{...s,is_dismissed:!0}:s));try{const{error:a}=await g.from("tasks").update({is_dismissed:!0}).eq("id",r);if(a)throw i(s=>s.map(l=>l.id===r?{...l,is_dismissed:!1}:l)),a}catch(a){console.error("Error dismissing task:",a)}}},[d,i]),c=b.useCallback(async r=>{if(d.find(a=>a.id===r)){i(a=>a.map(s=>s.id===r?{...s,is_dismissed:!1}:s));try{const{error:a}=await g.from("tasks").update({is_dismissed:!1}).eq("id",r);if(a)throw i(s=>s.map(l=>l.id===r?{...l,is_dismissed:!0}:l)),a}catch(a){console.error("Error restoring task:",a)}}},[d,i]),m=b.useCallback(async(r,e)=>{const a=d.find(l=>l.id===r);if(!a)return;const s={...a,...e};i(l=>l.map(o=>o.id===r?s:o));try{const{error:l}=await g.from("tasks").update(e).eq("id",r);if(l)throw i(o=>o.map(f=>f.id===r?a:f)),l}catch(l){console.error("Error editing task:",l)}},[d,i]);return{addTask:p,toggleTaskCompletion:u,deleteTask:x,dismissTask:h,restoreTask:c,editTask:m}}function A({user:n,categories:d,setCategories:i}){const p=b.useCallback(async c=>{const m=d.find(e=>e.id===c);if(!m)return;const r=!m.is_active;i(e=>e.map(a=>a.id===c?{...a,is_active:r}:a));try{const{error:e}=await g.from("task_categories").update({is_active:r}).eq("id",c);if(e)throw i(a=>a.map(s=>s.id===c?m:s)),e}catch(e){console.error("Error toggling category:",e)}},[d,i]),u=b.useCallback(async c=>{if(!n)return;const m={name:c,is_active:!0,user_id:n.id};try{const{data:r,error:e}=await g.from("task_categories").insert(m).select().single();if(e)throw e;i(a=>[...a,r])}catch(r){console.error("Error adding category:",r)}},[n,i]),x=b.useCallback(async c=>{const m=d.find(r=>r.id===c);if(m){i(r=>r.filter(e=>e.id!==c));try{const{error:r}=await g.from("tasks").delete().eq("category_id",c);if(r){console.error("Error deleting category tasks:",r),i(a=>[...a,m]);return}const{error:e}=await g.from("task_categories").delete().eq("id",c);if(e)throw i(a=>[...a,m]),e}catch(r){console.error("Error deleting category:",r)}}},[d,i]),h=b.useCallback(async c=>{i(m=>m.map(r=>{const e=c.findIndex(a=>a.id===r.id);return e!==-1?{...r,order_index:e}:r}).sort((r,e)=>(r.order_index??0)-(e.order_index??0)));try{const m=c.map((e,a)=>({id:e.id,order_index:a,user_id:n?.id,name:e.name,is_active:e.is_active})),{error:r}=await g.from("task_categories").upsert(m,{onConflict:"id"});if(r)throw r}catch(m){console.error("Error reordering categories:",m)}},[i,n]);return{toggleCategory:p,addCategory:u,deleteCategory:x,reorderCategories:h}}function U(){const{tasks:n,setTasks:d,categories:i,setCategories:p,isLoading:u,user:x}=P(),{addTask:h,toggleTaskCompletion:c,deleteTask:m,dismissTask:r,restoreTask:e,editTask:a}=$({user:x,tasks:n,setTasks:d}),{toggleCategory:s,addCategory:l,deleteCategory:o,reorderCategories:f}=A({user:x,categories:i,setCategories:p});return{tasks:n,categories:i,isLoading:u,addTask:h,toggleTaskCompletion:c,deleteTask:m,toggleCategory:s,addCategory:l,deleteCategory:async j=>{d(y=>y.filter(N=>N.category_id!==j)),await o(j)},dismissTask:r,restoreTask:e,editTask:a,reorderCategories:f}}function L({isOpen:n,onClose:d,onSubmit:i,categories:p,initialData:u}){const[x,h]=b.useState(u?.description||""),[c,m]=b.useState(u?.category_id||p[0]?.id||""),[r,e]=b.useState(u?.priority||1),[a,s]=b.useState(u?.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");b.useEffect(()=>{if(n){if(u)h(u.description),m(u.category_id),e(u.priority),s(u.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");else if(p.length>0&&!x&&!u){const o=p.some(f=>f.id===c);(!c||!o)&&m(p[0].id)}}n&&!u&&!x&&(e(1),s(""))},[n,p,c,u]);const l=o=>{o.preventDefault(),!(!x.trim()||!c)&&(i({description:x,category_id:c,priority:r,deadline:a?new Date(a).toISOString():void 0}),u||(h(""),e(1),s("")),d())};return t.jsx(E,{children:n&&t.jsxs(t.Fragment,{children:[t.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d,className:"fixed inset-0 bg-brand-neutral-darker/70 backdrop-blur-sm z-50"}),t.jsx(w.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:t.jsxs("div",{className:"w-full max-w-lg bg-brand-neutral-darker border border-brand-depth rounded-2xl shadow-2xl pointer-events-auto mx-4 overflow-hidden",children:[t.jsxs("div",{className:"p-6 border-b border-brand-depth flex justify-between items-center bg-brand-neutral-dark/50",children:[t.jsx("h2",{className:"text-xl font-bold text-brand-neutral-light",children:u?"Edytuj zadanie":"Dodaj nowe zadanie"}),t.jsx("button",{onClick:d,className:"text-brand-neutral-light/60 hover:text-brand-neutral-light transition-colors",children:t.jsx(T,{})})]}),t.jsxs("form",{onSubmit:l,className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Treść zadania"}),t.jsx("textarea",{value:x,onChange:o=>h(o.target.value),className:`w-full px-4 py-3 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light placeholder-brand-neutral-light/30 focus:outline-none focus:border-brand-primary`,placeholder:"Co musisz zrobić?",rows:3,required:!0})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Kategoria"}),t.jsx("select",{value:c,onChange:o=>m(o.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                             text-brand-neutral-light focus:outline-none focus:border-brand-primary`,children:p.map(o=>t.jsx("option",{value:o.id,children:o.name},o.id))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Priorytet"}),t.jsx("div",{className:"flex gap-2",children:[1,2,3].map(o=>t.jsx("button",{type:"button",onClick:()=>e(o),className:`flex-1 py-2.5 rounded-xl border transition-all font-bold text-sm
                                                ${r===o?o===3?"bg-brand-negative text-white border-brand-negative":o===2?"bg-brand-accent-3 text-white border-brand-accent-3":"bg-brand-accent-2 text-white border-brand-accent-2":"border-brand-depth text-brand-neutral-light/60 hover:border-brand-neutral-light/40"}`,children:o===3?"!!!":o===2?"!!":"!"},o))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Termin (opcjonalnie)"}),t.jsx("input",{type:"date",value:a,onChange:o=>s(o.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light focus:outline-none focus:border-brand-primary [color-scheme:dark]`})]}),t.jsx("div",{className:"pt-4",children:t.jsx("button",{type:"submit",className:`w-full py-3 bg-brand-primary rounded-xl text-brand-neutral-light font-bold \r
                                         hover:bg-brand-primary/90 transition-all shadow-lg active:scale-97 cursor-pointer`,children:u?"Zapisz zmiany":"Dodaj zadanie"})})]})]})})]})})}function O({task:n,categories:d,onComplete:i,onDismiss:p,onEdit:u,currentDate:x}){const h={1:"border-brand-accent-2/50 bg-brand-accent-2/10",2:"border-brand-accent-1/50 bg-brand-accent-1/10",3:"border-brand-negative/50 bg-brand-negative/10"},c={1:"Niski",2:"Normalny",3:"Wysoki"},r=(y=>{if(!y)return null;const N=new Date(y),_=new Date(x);N.setHours(0,0,0,0),_.setHours(0,0,0,0);const S=N.getTime()-_.getTime(),v=Math.ceil(S/(1e3*60*60*24));return v<0?{text:`Dni opóźnienia: ${Math.abs(v)}`,className:"text-brand-negative font-bold"}:v===0?{text:"Dzisiaj",className:"text-brand-accent-3 font-bold"}:v===1?{text:"Jutro",className:"text-brand-neutral-light/80"}:{text:`Pozostałe dni: ${v}`,className:"text-brand-neutral-light/60"}})(n.deadline),e=n.is_completed,a=e?"bg-brand-neutral-dark/40 border-brand-neutral-light/20 opacity-70":h[n.priority],[s,l]=b.useState(!1),[o,f]=b.useState(!1),[C,j]=b.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs(w.div,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},onClick:()=>l(!s),className:`relative p-3 rounded-xl border ${a} 
                    group hover:shadow-md transition-all cursor-pointer select-none`,children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("button",{onClick:y=>{y.stopPropagation(),i(n.id)},className:`mt-1 w-5 h-5 rounded-full border-2 transition-all flex-shrink-0 flex items-center justify-center cursor-pointer
                       ${e?"bg-brand-positive border-brand-positive text-brand-neutral-darker":"border-brand-neutral-light/50 hover:border-brand-accent-1 hover:bg-brand-accent-1/20"}`,children:e&&t.jsx(k,{className:"scale-75"})}),t.jsxs("div",{className:"flex-grow min-w-0",children:[t.jsx("p",{className:`text-brand-neutral-light text-sm font-medium leading-tight break-words transition-all
                        ${e?"line-through text-brand-neutral-light/50 truncate pr-17":"truncate"}`,children:n.description}),s&&t.jsx(w.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-2 text-xs text-brand-neutral-light/70 whitespace-pre-wrap border-l-2 border-brand-neutral-light/20 pl-2",children:t.jsx("span",{className:"block mt-1 pt-1 border-t border-brand-neutral-light/10",children:n.description})}),t.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[!e&&t.jsxs("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded
                               ${n.priority===3?"text-brand-negative-darker/60 bg-brand-negative/30":n.priority===2?"text-brand-accent-1/90 bg-brand-accent-3/30":"text-brand-neutral-light/80 bg-brand-accent-2/30"}`,children:[c[n.priority]," priorytet"]}),r&&!e&&t.jsx("span",{className:`text-[10px] ${r.className}`,children:r.text}),e&&n.completed_at&&t.jsxs("span",{className:"text-[10px] text-brand-neutral-light/40",children:["Ukończono: ",new Date(n.completed_at).toLocaleDateString()]})]})]})]}),!e&&s&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100",children:t.jsx("button",{onClick:y=>{y.stopPropagation(),j(!0)},className:`p-1 hover:bg-brand-neutral-light/20 rounded-full text-brand-neutral-light/60 hover:text-brand-neutral-light \r
                     text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Edytuj",children:t.jsx(D,{className:"scale-75"})})}),e&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx("button",{onClick:y=>{y.stopPropagation(),f(!0)},className:`p-1 hover:bg-brand-negative/20 rounded-full text-brand-neutral-light/60 hover:text-brand-negative-darker \r
                    text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Usuń",children:t.jsx(M,{className:"scale-85"})})})]}),t.jsx(q,{isOpen:o,onClose:()=>f(!1),onConfirm:()=>p(n.id),title:"Przenieś do historii",confirmLabel:"Przenieś",description:t.jsxs("p",{children:["Czy na pewno chcesz przenieść to zadanie"," ",n.description?t.jsxs(t.Fragment,{children:["(",t.jsx("strong",{className:"text-brand-neutral-light truncate inline-block max-w-[200px] align-bottom",children:n.description}),")"]}):""," ","do historii?"]})}),t.jsx(L,{isOpen:C,onClose:()=>j(!1),onSubmit:y=>u(n.id,y),categories:d,initialData:n})]})}function B({category:n,tasks:d,allCategories:i,onComplete:p,onDismiss:u,onEdit:x,currentDate:h}){const c=b.useMemo(()=>[...d].sort((e,a)=>e.is_completed!==a.is_completed?e.is_completed?1:-1:a.priority!==e.priority?a.priority-e.priority:new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),[d]),m=d.filter(e=>e.is_completed),r=d.length>0&&m.length===d.length;return t.jsxs("div",{className:"flex flex-col h-full bg-brand-neutral-dark/30 border border-brand-depth rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:`p-4 border-b border-brand-depth flex items-center justify-between
                      ${r?"bg-brand-positive/10":"bg-brand-neutral-dark/40"}`,children:[t.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:r&&t.jsx(w.div,{initial:{scale:0},animate:{scale:1},className:"w-6 h-6 bg-brand-positive rounded-full flex items-center justify-center text-brand-neutral-darker",children:t.jsx(k,{className:"scale-90"})})}),t.jsx("h3",{className:"font-bold text-lg text-brand-neutral-light truncate",children:n.name}),t.jsx("span",{className:"text-xs text-brand-neutral-light/40 bg-brand-neutral-dark/50 px-2 py-1 rounded-lg",children:d.length})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3 min-h-[200px]",children:[t.jsx(E,{mode:"popLayout",children:c.map(e=>t.jsx(O,{task:e,categories:i,onComplete:p,onDismiss:u,onEdit:x,currentDate:h},e.id))}),d.length===0&&t.jsx("div",{className:"h-full flex flex-col items-center justify-center text-brand-neutral-light/30 p-4 text-center",children:t.jsx("p",{className:"text-sm",children:"Brak zadań"})})]})]})}export{L as A,B as T,U as u};
