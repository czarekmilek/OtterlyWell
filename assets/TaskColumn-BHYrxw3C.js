import{a as z,r as b,s as f,j as t,m as v,k as T,g as C,l as D,q}from"./index-CnzLdIVn.js";import{A as E,C as M}from"./ConfirmDeleteDialog-DtyGYduC.js";function P(){const{user:o}=z(),[d,i]=b.useState([]),[p,u]=b.useState([]),[x,h]=b.useState(!0),m=b.useCallback(async()=>{if(o)try{const{data:n,error:r}=await f.from("task_categories").select("*").order("order_index",{ascending:!0}).order("created_at",{ascending:!0});if(r)throw r;u(n||[])}catch(n){console.error("Error fetching categories:",n)}},[o]),c=b.useCallback(async()=>{if(o)try{const{data:n,error:r}=await f.from("tasks").select("*").order("priority",{ascending:!1}).order("created_at",{ascending:!1});if(r)throw r;i(n||[])}catch(n){console.error("Error fetching tasks:",n)}},[o]);return b.useEffect(()=>{o&&(async()=>{h(!0),await Promise.all([m(),c()]),h(!1)})()},[o,m,c]),{tasks:d,setTasks:i,categories:p,setCategories:u,isLoading:x,user:o}}function $({user:o,tasks:d,setTasks:i}){const p=b.useCallback(async n=>{if(!o)return;const r={...n,user_id:o.id,is_completed:!1};try{const{data:e,error:a}=await f.from("tasks").insert(r).select().single();if(a)throw a;i(s=>[...s,e])}catch(e){console.error("Error adding task:",e)}},[o,i]),u=b.useCallback(async n=>{const r=d.find(s=>s.id===n);if(!r)return;const e=!r.is_completed,a=e?new Date().toISOString():null;i(s=>s.map(l=>l.id===n?{...l,is_completed:e,completed_at:a||void 0}:l));try{const{error:s}=await f.from("tasks").update({is_completed:e,completed_at:a}).eq("id",n);if(s)throw i(l=>l.map(y=>y.id===n?r:y)),s}catch(s){console.error("Error toggling task completion:",s)}},[d,i]),x=b.useCallback(async n=>{const r=[...d];i(e=>e.filter(a=>a.id!==n));try{const{error:e}=await f.from("tasks").delete().eq("id",n);if(e)throw i(r),e}catch(e){console.error("Error deleting task:",e)}},[d,i]),h=b.useCallback(async n=>{if(d.find(e=>e.id===n)){i(e=>e.map(a=>a.id===n?{...a,is_dismissed:!0}:a));try{const{error:e}=await f.from("tasks").update({is_dismissed:!0}).eq("id",n);if(e)throw i(a=>a.map(s=>s.id===n?{...s,is_dismissed:!1}:s)),e}catch(e){console.error("Error dismissing task:",e)}}},[d,i]),m=b.useCallback(async n=>{if(d.find(e=>e.id===n)){i(e=>e.map(a=>a.id===n?{...a,is_dismissed:!1}:a));try{const{error:e}=await f.from("tasks").update({is_dismissed:!1}).eq("id",n);if(e)throw i(a=>a.map(s=>s.id===n?{...s,is_dismissed:!0}:s)),e}catch(e){console.error("Error restoring task:",e)}}},[d,i]),c=b.useCallback(async(n,r)=>{const e=d.find(s=>s.id===n);if(!e)return;const a={...e,...r};i(s=>s.map(l=>l.id===n?a:l));try{const{error:s}=await f.from("tasks").update(r).eq("id",n);if(s)throw i(l=>l.map(y=>y.id===n?e:y)),s}catch(s){console.error("Error editing task:",s)}},[d,i]);return{addTask:p,toggleTaskCompletion:u,deleteTask:x,dismissTask:h,restoreTask:m,editTask:c}}function A({user:o,categories:d,setCategories:i}){const p=b.useCallback(async c=>{const n=d.find(e=>e.id===c);if(!n)return;const r=!n.is_active;i(e=>e.map(a=>a.id===c?{...a,is_active:r}:a));try{const{error:e}=await f.from("task_categories").update({is_active:r}).eq("id",c);if(e)throw i(a=>a.map(s=>s.id===c?n:s)),e}catch(e){console.error("Error toggling category:",e)}},[d,i]),u=b.useCallback(async c=>{if(!o)return;const n={name:c,is_active:!0,user_id:o.id};try{const{data:r,error:e}=await f.from("task_categories").insert(n).select().single();if(e)throw e;i(a=>[...a,r])}catch(r){console.error("Error adding category:",r)}},[o,i]),x=b.useCallback(async c=>{const n=d.find(r=>r.id===c);if(n){i(r=>r.filter(e=>e.id!==c));try{const{error:r}=await f.from("tasks").delete().eq("category_id",c);if(r){console.error("Error deleting category tasks:",r),i(a=>[...a,n]);return}const{error:e}=await f.from("task_categories").delete().eq("id",c);if(e)throw i(a=>[...a,n]),e}catch(r){console.error("Error deleting category:",r)}}},[d,i]),h=b.useCallback(async c=>{i(n=>n.map(r=>{const e=c.findIndex(a=>a.id===r.id);return e!==-1?{...r,order_index:e}:r}).sort((r,e)=>(r.order_index??0)-(e.order_index??0)));try{const n=c.map((e,a)=>({id:e.id,order_index:a,user_id:o?.id,name:e.name,is_active:e.is_active})),{error:r}=await f.from("task_categories").upsert(n,{onConflict:"id"});if(r)throw r}catch(n){console.error("Error reordering categories:",n)}},[i,o]),m=b.useCallback(async(c,n)=>{const r=d.find(e=>e.id===c);if(r&&r.name!==n){i(e=>e.map(a=>a.id===c?{...a,name:n}:a));try{const{error:e}=await f.from("task_categories").update({name:n}).eq("id",c);if(e)throw i(a=>a.map(s=>s.id===c?r:s)),e}catch(e){console.error("Error updating category:",e)}}},[d,i]);return{toggleCategory:p,addCategory:u,deleteCategory:x,reorderCategories:h,editCategory:m}}function U(){const{tasks:o,setTasks:d,categories:i,setCategories:p,isLoading:u,user:x}=P(),{addTask:h,toggleTaskCompletion:m,deleteTask:c,dismissTask:n,restoreTask:r,editTask:e}=$({user:x,tasks:o,setTasks:d}),{toggleCategory:a,addCategory:s,deleteCategory:l,reorderCategories:y,editCategory:k}=A({user:x,categories:i,setCategories:p});return{tasks:o,categories:i,isLoading:u,addTask:h,toggleTaskCompletion:m,deleteTask:c,toggleCategory:a,addCategory:s,deleteCategory:async g=>{d(w=>w.filter(N=>N.category_id!==g)),await l(g)},dismissTask:n,restoreTask:r,editTask:e,reorderCategories:y,editCategory:k}}function L({isOpen:o,onClose:d,onSubmit:i,categories:p,initialData:u}){const[x,h]=b.useState(u?.description||""),[m,c]=b.useState(u?.category_id||p[0]?.id||""),[n,r]=b.useState(u?.priority||1),[e,a]=b.useState(u?.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");b.useEffect(()=>{if(o){if(u)h(u.description),c(u.category_id),r(u.priority),a(u.deadline?new Date(u.deadline).toISOString().split("T")[0]:"");else if(p.length>0&&!x&&!u){const l=p.some(y=>y.id===m);(!m||!l)&&c(p[0].id)}}o&&!u&&!x&&(r(1),a(""))},[o,p,m,u]);const s=l=>{l.preventDefault(),!(!x.trim()||!m)&&(i({description:x,category_id:m,priority:n,deadline:e?new Date(e).toISOString():void 0}),u||(h(""),r(1),a("")),d())};return t.jsx(E,{children:o&&t.jsxs(t.Fragment,{children:[t.jsx(v.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d,className:"fixed inset-0 bg-brand-neutral-darker/70 backdrop-blur-sm z-50"}),t.jsx(v.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:t.jsxs("div",{className:"w-full max-w-lg bg-brand-neutral-darker border border-brand-depth rounded-2xl shadow-2xl pointer-events-auto mx-4 overflow-hidden",children:[t.jsxs("div",{className:"p-6 border-b border-brand-depth flex justify-between items-center bg-brand-neutral-dark/50",children:[t.jsx("h2",{className:"text-xl font-bold text-brand-neutral-light",children:u?"Edytuj zadanie":"Dodaj nowe zadanie"}),t.jsx("button",{onClick:d,className:`text-brand-secondary hover:text-brand-neutral-dark hover:bg-brand-neutral-light/70 rounded-full \r
                  p-1 flex items-center justify-center cursor-pointer transition-all`,children:t.jsx(T,{})})]}),t.jsxs("form",{onSubmit:s,className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Treść zadania"}),t.jsx("textarea",{value:x,onChange:l=>h(l.target.value),className:`w-full px-4 py-3 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light placeholder-brand-neutral-light/30 focus:outline-none focus:border-brand-primary`,placeholder:"Co musisz zrobić?",rows:3,required:!0})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Kategoria"}),t.jsx("select",{value:m,onChange:l=>c(l.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                             text-brand-neutral-light focus:outline-none focus:border-brand-primary`,children:p.map(l=>t.jsx("option",{value:l.id,children:l.name},l.id))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Priorytet"}),t.jsx("div",{className:"flex gap-2",children:[1,2,3].map(l=>t.jsx("button",{type:"button",onClick:()=>r(l),className:`flex-1 py-2.5 rounded-xl border transition-all font-bold text-sm
                                                ${n===l?l===3?"bg-brand-negative text-white border-brand-negative":l===2?"bg-brand-accent-3 text-white border-brand-accent-3":"bg-brand-accent-2 text-white border-brand-accent-2":"border-brand-depth text-brand-neutral-light/60 hover:border-brand-neutral-light/40"}`,children:l===3?"!!!":l===2?"!!":"!"},l))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-brand-neutral-light/80 mb-1",children:"Termin (opcjonalnie)"}),t.jsx("input",{type:"date",value:e,onChange:l=>a(l.target.value),className:`w-full px-4 py-2.5 bg-brand-neutral-dark/40 border border-brand-depth rounded-xl \r
                                         text-brand-neutral-light focus:outline-none focus:border-brand-primary [color-scheme:dark]`})]}),t.jsx("div",{className:"pt-4",children:t.jsx("button",{type:"submit",className:`w-full py-3 bg-brand-primary rounded-xl text-brand-neutral-light font-bold \r
                                         hover:bg-brand-primary/90 transition-all shadow-lg active:scale-97 cursor-pointer`,children:u?"Zapisz zmiany":"Dodaj zadanie"})})]})]})})]})})}function O({task:o,categories:d,onComplete:i,onDismiss:p,onEdit:u,currentDate:x}){const h={1:"border-brand-accent-2/50 bg-brand-accent-2/10",2:"border-brand-accent-1/50 bg-brand-accent-1/10",3:"border-brand-negative/50 bg-brand-negative/10"},m={1:"Niski",2:"Normalny",3:"Wysoki"},n=(g=>{if(!g)return null;const w=new Date(g),N=new Date(x);w.setHours(0,0,0,0),N.setHours(0,0,0,0);const S=w.getTime()-N.getTime(),j=Math.ceil(S/(1e3*60*60*24));return j<0?{text:`Dni opóźnienia: ${Math.abs(j)}`,className:"text-brand-negative font-bold"}:j===0?{text:"Dzisiaj",className:"text-brand-accent-3 font-bold"}:j===1?{text:"Jutro",className:"text-brand-neutral-light/80"}:{text:`Pozostałe dni: ${j}`,className:"text-brand-neutral-light/60"}})(o.deadline),r=o.is_completed,e=r?"bg-brand-neutral-dark/40 border-brand-neutral-light/20 opacity-70":h[o.priority],[a,s]=b.useState(!1),[l,y]=b.useState(!1),[k,_]=b.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsxs(v.div,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},onClick:()=>s(!a),className:`relative p-3 rounded-xl border ${e} 
                    group hover:shadow-md transition-all cursor-pointer select-none`,children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("button",{onClick:g=>{g.stopPropagation(),i(o.id)},className:`mt-1 w-5 h-5 rounded-full border-2 transition-all flex-shrink-0 flex items-center justify-center cursor-pointer
                       ${r?"bg-brand-positive border-brand-positive hover:bg-brand-secondary hover:border-brand-secondary text-brand-neutral-darker":"border-brand-neutral-light/50 hover:border-brand-accent-1 hover:bg-brand-accent-1/20"}`,children:r&&t.jsx(C,{className:"scale-75"})}),t.jsxs("div",{className:"flex-grow min-w-0",children:[t.jsx("p",{className:`text-brand-neutral-light text-sm font-medium leading-tight break-words transition-all
                        ${r?"line-through text-brand-neutral-light/50 truncate pr-17":"truncate pr-17"}`,children:o.description}),a&&t.jsx(v.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-2 text-xs text-brand-neutral-light/70 whitespace-pre-wrap border-l-2 border-brand-neutral-light/20 pl-2",children:t.jsx("span",{className:"block mt-1 pt-1 border-t border-brand-neutral-light/10",children:o.description})}),t.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[!r&&t.jsxs("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded
                               ${o.priority===3?"text-brand-negative-darker/60 bg-brand-negative/30":o.priority===2?"text-brand-accent-1/90 bg-brand-accent-3/30":"text-brand-neutral-light/80 bg-brand-accent-2/30"}`,children:[m[o.priority]," priorytet"]}),n&&!r&&t.jsx("span",{className:`text-[10px] ${n.className}`,children:n.text}),r&&o.completed_at&&t.jsxs("span",{className:"text-[10px] text-brand-neutral-light/40",children:["Ukończono: ",new Date(o.completed_at).toLocaleDateString()]})]})]})]}),!r&&a&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100",children:t.jsx("button",{onClick:g=>{g.stopPropagation(),_(!0)},className:`p-1 hover:bg-brand-neutral-light/20 rounded-full text-brand-neutral-light/60 hover:text-brand-neutral-light \r
                     text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Edytuj",children:t.jsx(D,{className:"scale-75"})})}),r&&t.jsx("div",{className:"absolute top-1 right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx("button",{onClick:g=>{g.stopPropagation(),y(!0)},className:`p-1 hover:bg-brand-negative/20 rounded-full text-brand-neutral-light/60 hover:text-brand-negative-darker \r
                    text-xs transition-all cursor-pointer flex items-center justify-center`,title:"Usuń",children:t.jsx(q,{className:"scale-85"})})})]}),t.jsx(M,{isOpen:l,onClose:()=>y(!1),onConfirm:()=>p(o.id),title:"Przenieś do historii",confirmLabel:"Przenieś",description:t.jsxs("p",{children:["Czy na pewno chcesz przenieść to zadanie"," ",o.description?t.jsxs(t.Fragment,{children:["(",t.jsx("strong",{className:"text-brand-neutral-light truncate inline-block max-w-[200px] align-bottom",children:o.description}),")"]}):""," ","do historii?"]})}),t.jsx(L,{isOpen:k,onClose:()=>_(!1),onSubmit:g=>u(o.id,g),categories:d,initialData:o})]})}function B({category:o,tasks:d,allCategories:i,onComplete:p,onDismiss:u,onEdit:x,currentDate:h}){const m=b.useMemo(()=>[...d].sort((r,e)=>r.is_completed!==e.is_completed?r.is_completed?1:-1:e.priority!==r.priority?e.priority-r.priority:new Date(e.created_at).getTime()-new Date(r.created_at).getTime()),[d]),c=d.filter(r=>r.is_completed),n=d.length>0&&c.length===d.length;return t.jsxs("div",{className:"flex flex-col h-full bg-brand-neutral-dark/30 border border-brand-depth rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:`p-4 border-b border-brand-depth flex items-center justify-between
                      ${n?"bg-brand-positive/10":"bg-brand-neutral-dark/40"}`,children:[t.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:n&&t.jsx(v.div,{initial:{scale:0},animate:{scale:1},className:"w-6 h-6 bg-brand-positive rounded-full flex items-center justify-center text-brand-neutral-darker",children:t.jsx(C,{className:"scale-90"})})}),t.jsx("h3",{className:"font-bold text-lg text-brand-neutral-light truncate",children:o.name}),t.jsx("span",{className:"text-xs text-brand-neutral-light/40 bg-brand-neutral-dark/50 px-2 py-1 rounded-lg",children:d.length})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3 min-h-[200px]",children:[t.jsx(E,{mode:"popLayout",children:m.map(r=>t.jsx(O,{task:r,categories:i,onComplete:p,onDismiss:u,onEdit:x,currentDate:h},r.id))}),d.length===0&&t.jsx("div",{className:"h-full flex flex-col items-center justify-center text-brand-neutral-light/30 p-4 text-center",children:t.jsx("p",{className:"text-sm",children:"Brak zadań"})})]})]})}export{L as A,B as T,U as u};
